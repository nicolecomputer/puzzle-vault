<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Source Details - {{ source_title }}</title>
    <link rel="stylesheet" href="/static/css/base.css?v={{ cache_buster }}">
    <link rel="stylesheet" href="/static/css/source_detail.css?v={{ cache_buster }}">
    <link rel="stylesheet" href="/static/css/agent_detail.css?v={{ cache_buster }}">
</head>

<body>
    <div class="container">
        <div class="page-header">
            <h1>{{ source_title }}</h1>
            <form action="/agents/run" method="POST" style="margin: 0;">
                <input type="hidden" name="source_id" value="{{ source_id }}">
                <input type="hidden" name="return_url" value="/sources/{{ source_id }}">
                <button type="submit" class="add-puzzle-btn">Check for Update</button>
            </form>
        </div>

        <table class="data-table info-table">
            <tr>
                <th>Latest Puzzle Date</th>
                <td>{% if latest_puzzle_date != 'N/A' %}{{ latest_puzzle_date.strftime('%B %d, %Y') }}{% else %}N/A{%
                    endif %}</td>
            </tr>
            <tr>
                <th>Last Update</th>
                <td>
                    {% if latest_run %}
                    <a href="/agents/runs/{{ latest_run.id }}">
                        {% if latest_run.queued_at %}{{ latest_run.queued_at.strftime('%b %d, %Y %I:%M %p') }}{% else
                        %}N/A{% endif %}
                    </a>
                    <span class="badge badge-{{ latest_run.status }}" style="margin-left: 8px;">
                        {{ latest_run.status }}
                    </span>
                    {% else %}
                    N/A
                    {% endif %}
                </td>
            </tr>
        </table>

        <table class="link-section">
            <tr>
                <th>Puzzlecast Feed</th>
            </tr>
            <tr>
                <td>
                    <div class="feed-url-container">
                        <a href="{{ feed_url }}" class="feed-link">{{ feed_url }}</a>
                        <button class="copy-btn" onclick="copyFeedUrl()">Copy</button>
                    </div>
                </td>
            </tr>
        </table>

        <table class="puzzles-section">
            <tr>
                <th colspan="4">{{ total_puzzles }} Puzzles</th>
            </tr>
            <tr class="puzzles-header">
                <th>Date</th>
                <th class="hide-mobile">Title</th>
                <th class="hide-mobile">Author</th>
                <th>Download</th>
            </tr>
            {% if puzzles %}
            {% for puzzle in puzzles %}
            <tr>
                <td>
                    <a href="/puzzles/{{ puzzle.id }}?key={{ feed_key }}" class="puzzle-link">
                        {% if puzzle.puzzle_date %}{{ puzzle.puzzle_date.strftime('%b %d, %Y') }}{% else %}N/A{% endif
                        %}
                    </a>
                </td>
                <td class="hide-mobile">{{ puzzle.title }}</td>
                <td class="hide-mobile">{{ puzzle.author or 'Unknown' }}</td>
                <td>
                    <button class="download-btn" onclick="downloadPuzzle('{{ puzzle.id }}')">Download</button>
                </td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
                <td colspan="4" class="no-puzzles">No puzzles found</td>
            </tr>
            {% endif %}
        </table>

        {% if total_pages > 1 %}
        <div class="pagination">
            {% if page > 1 %}
            <a href="/sources/{{ source_id }}?page={{ page - 1 }}" class="btn btn-link pagination-btn">← Previous</a>
            {% else %}
            <span class="btn btn-link pagination-btn disabled">← Previous</span>
            {% endif %}

            <span class="pagination-info">Page {{ page }} of {{ total_pages }}</span>

            {% if page < total_pages %} <a href="/sources/{{ source_id }}?page={{ page + 1 }}"
                class="btn btn-link pagination-btn">
                Next →</a>
                {% else %}
                <span class="btn btn-link pagination-btn disabled">Next →</span>
                {% endif %}
        </div>
        {% endif %}
    </div>

    <script>
        function copyFeedUrl() {
            const feedUrl = "{{ feed_url }}";
            const fullUrl = window.location.origin + feedUrl;
            navigator.clipboard.writeText(fullUrl).then(() => {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        function downloadPuzzle(puzzleId) {
            window.location.href = `/puzzles/${puzzleId}/download`;
        }
    </script>
</body>

</html>
