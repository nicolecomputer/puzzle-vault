<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Source</title>
    <link rel="stylesheet" href="/static/css/base.css?v={{ cache_buster }}">
    <link rel="stylesheet" href="/static/css/sources.css?v={{ cache_buster }}">
    <style>
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .page-header h1 {
            margin: 0;
        }

        .sources-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .custom-section {
            margin-top: 2rem;
        }

        .source-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: white;
            border: 1px solid var(--color-border);
            text-decoration: none;
            color: inherit;
            transition: all 0.2s;
            border-radius: 8px;
        }

        .source-item:hover {
            background: var(--color-bg-light);
            border-color: var(--color-primary);
        }

        .source-item.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        .source-item.disabled:hover {
            border-color: var(--color-border);
        }

        .source-icon {
            width: 48px;
            height: 48px;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .source-icon img {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            object-fit: cover;
        }

        .source-icon-placeholder {
            width: 100%;
            height: 100%;
            background: var(--color-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: 8px;
        }

        .source-info {
            flex: 1;
        }

        .source-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .source-updated {
            font-size: 0.9rem;
            color: var(--color-text-muted);
        }

        .source-arrow {
            font-size: 1.5rem;
            color: var(--color-text-muted);
        }

        .source-item.custom-option {
            background: var(--color-bg-light);
            border: 2px dashed var(--color-border);
        }

        .source-item.custom-option:hover {
            border-color: var(--color-primary);
            background: white;
            border-style: dashed;
        }

        .no-presets {
            text-align: center;
            padding: 2rem;
            color: var(--color-text-muted);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--color-text-muted);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="page-header">
            <h1>Add New Source</h1>
        </div>

        <div id="loading" class="loading">Loading available sources...</div>

        <div id="sources-list" class="sources-list" style="display: none;"></div>
    </div>

    <script>
        let agents = [];
        let takenShortCodes = [];

        // Fetch available agents and user's existing short codes
        Promise.all([
            fetch('/api/agents').then(r => r.json()),
            fetch('/api/sources/short-codes').then(r => r.json())
        ]).then(([agentsData, shortCodesData]) => {
            agents = agentsData.agents;
            takenShortCodes = shortCodesData.short_codes;
            renderSourceOptions();
        });

        function renderSourceOptions() {
            const loading = document.getElementById('loading');
            const sourcesList = document.getElementById('sources-list');

            loading.style.display = 'none';
            sourcesList.style.display = 'flex';
            sourcesList.innerHTML = '';

            let presetCount = 0;

            // Add preset options
            agents.forEach(agent => {
                if (agent.presets && agent.presets.length > 0) {
                    agent.presets.forEach(preset => {
                        const isTaken = takenShortCodes.includes(preset.short_code);
                        const item = createSourceItem(agent, preset, isTaken);
                        sourcesList.appendChild(item);
                        presetCount++;
                    });
                }
            });

            // Add custom option in a separate section
            const customSection = document.createElement('div');
            customSection.className = 'custom-section';

            const customItem = document.createElement('a');
            customItem.href = '/sources/new_custom';
            customItem.className = 'source-item custom-option';

            const customIcon = document.createElement('div');
            customIcon.className = 'source-icon';
            const customIconPlaceholder = document.createElement('div');
            customIconPlaceholder.className = 'source-icon-placeholder';
            customIconPlaceholder.textContent = '+';
            customIcon.appendChild(customIconPlaceholder);

            const customInfo = document.createElement('div');
            customInfo.className = 'source-info';

            const customName = document.createElement('div');
            customName.className = 'source-name';
            customName.textContent = 'Custom Source';

            const customDesc = document.createElement('div');
            customDesc.className = 'source-updated';
            customDesc.textContent = 'Configure a source manually';

            customInfo.appendChild(customName);
            customInfo.appendChild(customDesc);

            const customArrow = document.createElement('div');
            customArrow.className = 'source-arrow';
            customArrow.textContent = '→';

            customItem.appendChild(customIcon);
            customItem.appendChild(customInfo);
            customItem.appendChild(customArrow);

            customSection.appendChild(customItem);
            sourcesList.appendChild(customSection);

            if (presetCount === 0) {
                const noPresets = document.createElement('div');
                noPresets.className = 'no-presets';
                noPresets.textContent = 'No preset sources available. Use the Custom option to create a source.';
                sourcesList.insertBefore(noPresets, customItem);
            }
        }

        function createSourceItem(agent, preset, isTaken) {
            const item = document.createElement('a');
            item.className = 'source-item' + (isTaken ? ' disabled' : '');

            if (!isTaken) {
                item.href = '#';
                item.onclick = (e) => {
                    e.preventDefault();
                    addPresetSource(agent, preset);
                };
            }

            const icon = document.createElement('div');
            icon.className = 'source-icon';
            const iconPlaceholder = document.createElement('div');
            iconPlaceholder.className = 'source-icon-placeholder';
            iconPlaceholder.textContent = preset.name[0].toUpperCase();
            icon.appendChild(iconPlaceholder);

            const info = document.createElement('div');
            info.className = 'source-info';

            const name = document.createElement('div');
            name.className = 'source-name';
            name.textContent = preset.name;

            const desc = document.createElement('div');
            desc.className = 'source-updated';
            desc.textContent = isTaken ? '✓ Already added' : `via ${agent.name}`;

            info.appendChild(name);
            info.appendChild(desc);

            const arrow = document.createElement('div');
            arrow.className = 'source-arrow';
            arrow.textContent = '→';

            item.appendChild(icon);
            item.appendChild(info);
            item.appendChild(arrow);

            return item;
        }

        async function addPresetSource(agent, preset) {
            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/sources/preset';

            const agentTypeInput = document.createElement('input');
            agentTypeInput.type = 'hidden';
            agentTypeInput.name = 'agent_type';
            agentTypeInput.value = agent.type;
            form.appendChild(agentTypeInput);

            const presetDataInput = document.createElement('input');
            presetDataInput.type = 'hidden';
            presetDataInput.name = 'preset_data';
            presetDataInput.value = JSON.stringify(preset);
            form.appendChild(presetDataInput);

            document.body.appendChild(form);
            form.submit();
        }
    </script>
</body>

</html>
