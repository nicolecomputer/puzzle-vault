<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Source</title>
    <link rel="stylesheet" href="/static/css/base.css?v={{ cache_buster }}">
    <style>
        .form-container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            margin-bottom: 2rem;
        }

        .source-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .form-actions .btn-cancel,
        .form-actions .btn-submit {
            flex: 1;
        }

        .agent-config-fields {
            display: none;
            padding: 1rem;
            background: var(--color-bg-light);
            border-radius: 4px;
            margin-top: 0.5rem;
        }

        .agent-config-fields.active {
            display: block;
        }

        .form-group label {
            font-size: 1.1rem;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <div class="container form-container">
        <h1>Add New Source</h1>
        <form class="source-form" method="post" action="/sources">
            <div class="form-group">
                <label for="name">Source Name</label>
                <input type="text" id="name" name="name" required autofocus>
            </div>
            <div class="form-group">
                <label for="short_code">Short Code (optional)</label>
                <input type="text" id="short_code" name="short_code" pattern="[a-z0-9-]+"
                    placeholder="e.g., nyt, wsj, latimes">
                <small>
                    Optional short code for folder names (lowercase letters, numbers, and hyphens only)
                </small>
            </div>
            <div class="form-group">
                <label for="agent_type">Agent Type</label>
                <select id="agent_type" name="agent_type">
                    <option value="">None (Manual Upload)</option>
                </select>
                <small>Select an agent to automatically fetch puzzles</small>
            </div>
            <div id="agent-config-container"></div>
            <input type="hidden" id="agent_config" name="agent_config" value="">
            <input type="hidden" name="agent_enabled" value="true">
            <div class="form-actions">
                <a href="/user/{{ username }}/sources" class="btn-cancel">Cancel</a>
                <button type="submit" class="btn-submit">Create Source</button>
            </div>
        </form>
    </div>

    <script>
        let agents = [];
        let currentAgentType = null;

        // Fetch available agents
        fetch('/api/agents')
            .then(response => response.json())
            .then(data => {
                agents = data.agents;
                const select = document.getElementById('agent_type');

                agents.forEach(agent => {
                    const option = document.createElement('option');
                    option.value = agent.type;
                    option.textContent = agent.name;
                    select.appendChild(option);
                });
            });

        // Handle agent type selection
        document.getElementById('agent_type').addEventListener('change', function (e) {
            const agentType = e.target.value;
            const container = document.getElementById('agent-config-container');

            container.innerHTML = '';
            currentAgentType = agentType;

            if (!agentType) {
                return;
            }

            const agent = agents.find(a => a.type === agentType);
            if (!agent || !agent.config_schema.properties) {
                return;
            }

            // Create form fields based on JSON schema
            const configDiv = document.createElement('div');
            configDiv.className = 'agent-config-fields active';

            Object.entries(agent.config_schema.properties).forEach(([key, schema]) => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';

                const label = document.createElement('label');
                label.htmlFor = `config_${key}`;
                label.textContent = schema.title || key;

                const input = document.createElement('input');
                input.type = 'text';
                input.id = `config_${key}`;
                input.name = `config_${key}`;
                input.dataset.configKey = key;

                if (schema.default !== undefined) {
                    input.value = schema.default;
                }

                if (schema.description) {
                    const small = document.createElement('small');
                    small.textContent = schema.description;
                    formGroup.appendChild(label);
                    formGroup.appendChild(input);
                    formGroup.appendChild(small);
                } else {
                    formGroup.appendChild(label);
                    formGroup.appendChild(input);
                }

                configDiv.appendChild(formGroup);
            });

            container.appendChild(configDiv);
        });

        // Build config JSON on submit
        document.querySelector('.source-form').addEventListener('submit', function (e) {
            if (!currentAgentType) {
                return;
            }

            const configInputs = document.querySelectorAll('[data-config-key]');
            const config = {};

            configInputs.forEach(input => {
                const key = input.dataset.configKey;
                config[key] = input.value;
            });

            document.getElementById('agent_config').value = JSON.stringify(config);
        });
    </script>
</body>

</html>
